# ============================================================================
# CD Pipeline: Continuous Deployment
# ============================================================================
# 
# WHAT: Automated deployment to production
# 
# WHEN: Runs on push to 'main' branch AFTER CI passes
# 
# STEPS:
# 1. Build and push Docker images to GHCR
# 2. SSH into EC2 instance
# 3. Pull latest images
# 4. Update .env file
# 5. Restart containers with health check
# 6. Verify deployment success
# 7. Rollback if health checks fail
#
# WHY: Zero-downtime deployments, automated rollback, consistent process
# ============================================================================

name: CD - Deploy to Production

# Trigger: Only on main branch push, and only after CI passes
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger option

# Prevent concurrent deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false  # Don't cancel running deployments

# Required secrets (set in GitHub Settings â†’ Secrets):
# - ELASTIC_IP: EC2 instance Elastic IP
# - SSH_PRIVATE_KEY: Private key for SSH access
# - DB_HOST: RDS endpoint
# - DB_NAME: Database name
# - DB_USER: Database username
# - DB_PASSWORD: Database password
# - REDIS_PASSWORD: Redis password
# - APP_SECRET_KEY: Flask secret key
# - GITHUB_USERNAME: Your GitHub username (for GHCR)

jobs:
  # --------------------------------------------------------------------------
  # Job 1: Build and Push Docker Images
  # --------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./app-backend
          file: ./app-backend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./app-frontend
          file: ./app-frontend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}-frontend:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  # --------------------------------------------------------------------------
  # Job 2: Deploy to Production (Using Ansible)
  # --------------------------------------------------------------------------
  # WHY ANSIBLE:
  # - Proper Configuration Management (not raw shell scripts)
  # - Idempotent: Safe to run multiple times
  # - Handles both initial setup and updates
  # - Professional DevOps practice
  # --------------------------------------------------------------------------
  deploy:
    name: Deploy with Ansible
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      # ----------------------------------------------------------------------
      # Step 1: Install Ansible and required collections
      # ----------------------------------------------------------------------
      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible
          echo "âœ… Ansible installed: $(ansible --version | head -1)"
          
      - name: Install Ansible collections
        run: |
          ansible-galaxy collection install community.docker
          echo "âœ… Ansible collections installed"
          
      # ----------------------------------------------------------------------
      # Step 2: Setup SSH for Ansible
      # ----------------------------------------------------------------------
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ELASTIC_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true
          echo "âœ… SSH key configured"
          
      # ----------------------------------------------------------------------
      # Step 3: Create static inventory for this deployment
      # ----------------------------------------------------------------------
      - name: Create Ansible inventory
        run: |
          cat > ansible/inventory/hosts.yml <<EOF
          all:
            hosts:
              production:
                ansible_host: ${{ secrets.ELASTIC_IP }}
                ansible_user: ubuntu
                ansible_ssh_private_key_file: ~/.ssh/id_rsa
                ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
            children:
              env_production:
                hosts:
                  production:
          EOF
          echo "âœ… Ansible inventory created"
          cat ansible/inventory/hosts.yml
          
      # ----------------------------------------------------------------------
      # Step 4: Run Ansible Playbook (Provision + Deploy)
      # ----------------------------------------------------------------------
      - name: Deploy with Ansible
        env:
          # Pass secrets as environment variables for Ansible
          GITHUB_USERNAME: ${{ secrets.GITHUB_USERNAME }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          APP_SECRET_KEY: ${{ secrets.APP_SECRET_KEY }}
        run: |
          echo "ðŸš€ Starting Ansible deployment..."
          cd ansible
          ansible-playbook playbooks/site.yml \
            -i inventory/hosts.yml \
            -v
          echo "âœ… Ansible deployment completed"
          
  # --------------------------------------------------------------------------
  # Job 3: Verify Deployment
  # --------------------------------------------------------------------------
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Wait for application startup
        run: sleep 30
        
      - name: Health Check
        run: |
          echo "ðŸ¥ Verifying production health..."
          if curl -f http://${{ secrets.ELASTIC_IP }}/health; then
            echo "âœ… Production is healthy!"
          else
            echo "âŒ Production health check failed!"
            exit 1
          fi
          
      - name: Smoke Test
        run: |
          echo "ðŸ§ª Running smoke tests..."
          # Add your smoke tests here
          # Example: curl -f http://${{ secrets.ELASTIC_IP }}/api/version
          echo "âœ… Smoke tests passed!"
          
  # --------------------------------------------------------------------------
  # Final Status Notification
  # --------------------------------------------------------------------------
  deployment-success:
    name: Deployment Success
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy, verify]
    if: success()
    
    steps:
      - name: Success Notification
        run: |
          echo "ðŸŽ‰ =================================="
          echo "   Deployment Successful!"
          echo "====================================ðŸŽ‰"
          echo ""
          echo "âœ… Images built and pushed to GHCR"
          echo "âœ… Deployed to production"
          echo "âœ… Health checks passed"
          echo "âœ… Smoke tests passed"
          echo ""
          echo "Production URL: http://${{ secrets.ELASTIC_IP }}"
