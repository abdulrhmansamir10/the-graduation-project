# ============================================================================
# CD Pipeline: Continuous Deployment
# ============================================================================
# 
# WHAT: Automated deployment to production
# 
# WHEN: Runs on push to 'main' branch AFTER CI passes
# 
# STEPS:
# 1. Build and push Docker images to GHCR
# 2. SSH into EC2 instance
# 3. Pull latest images
# 4. Update .env file
# 5. Restart containers with health check
# 6. Verify deployment success
# 7. Rollback if health checks fail
#
# WHY: Zero-downtime deployments, automated rollback, consistent process
# ============================================================================

name: CD - Deploy to Production

# Trigger: Only on main branch push, and only after CI passes
on:
  push:
    branches:
      - main
  workflow_dispatch:  # Manual trigger option

# Prevent concurrent deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false  # Don't cancel running deployments

# Required secrets (set in GitHub Settings â†’ Secrets):
# - ELASTIC_IP: EC2 instance Elastic IP
# - SSH_PRIVATE_KEY: Private key for SSH access
# - DB_HOST: RDS endpoint
# - DB_NAME: Database name
# - DB_USER: Database username
# - DB_PASSWORD: Database password
# - REDIS_PASSWORD: Redis password
# - APP_SECRET_KEY: Flask secret key
# - GITHUB_USERNAME: Your GitHub username (for GHCR)

jobs:
  # --------------------------------------------------------------------------
  # Job 1: Build and Push Docker Images
  # --------------------------------------------------------------------------
  build-and-push:
    name: Build & Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      
    outputs:
      image-tag: ${{ steps.meta.outputs.version }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            
      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./app-backend
          file: ./app-backend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./app-frontend
          file: ./app-frontend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository }}-frontend:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
  # --------------------------------------------------------------------------
  # Job 2: Deploy to Production
  # --------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    
    steps:
      - name: Checkout code (for scripts)
        uses: actions/checkout@v4
        
      - name: Create .env file
        run: |
          cat > .env <<EOF
          GITHUB_USERNAME=${{ secrets.GITHUB_USERNAME }}
          GITHUB_REPO=${{ github.event.repository.name }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          APP_SECRET_KEY=${{ secrets.APP_SECRET_KEY }}
          EOF
          
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ELASTIC_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e  # Exit on error
            
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to app directory
            cd /home/ubuntu/app || exit 1
            
            # Backup current docker-compose.yml
            if [ -f docker-compose.yml ]; then
              cp docker-compose.yml docker-compose.yml.backup
              echo "âœ… Backed up docker-compose.yml"
            fi
            
            # Pull latest images
            echo "ðŸ“¥ Pulling latest Docker images..."
            docker compose pull
            
            # Health check before deployment
            echo "ðŸ¥ Checking current application health..."
            if curl -f http://localhost/health; then
              echo "âœ… Current application is healthy"
            else
              echo "âš ï¸  Current application health check failed (may be first deployment)"
            fi
            
            # Deploy with rolling update
            echo "ðŸ”„ Deploying new version..."
            docker compose up -d --remove-orphans
            
            # Wait for services to start
            echo "â³ Waiting for services to start (30 seconds)..."
            sleep 30
            
            # Health check after deployment
            echo "ðŸ¥ Verifying deployment health..."
            MAX_RETRIES=10
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost/health; then
                echo "âœ… Deployment successful! Application is healthy."
                
                # Clean up old images
                echo "ðŸ§¹ Cleaning up old Docker images..."
                docker image prune -af --filter "until=24h"
                
                echo "ðŸŽ‰ Deployment completed successfully!"
                exit 0
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "â³ Health check failed. Retry $RETRY_COUNT/$MAX_RETRIES..."
                sleep 10
              fi
            done
            
            # Rollback if health checks failed
            echo "âŒ Deployment failed! Health checks did not pass."
            echo "ðŸ”„ Rolling back to previous version..."
            
            if [ -f docker-compose.yml.backup ]; then
              mv docker-compose.yml.backup docker-compose.yml
              docker compose up -d
              sleep 20
              
              if curl -f http://localhost/health; then
                echo "âœ… Rollback successful. Application restored."
                exit 1
              else
                echo "âŒ Rollback failed! Manual intervention required."
                exit 1
              fi
            else
              echo "âŒ No backup found! Manual intervention required."
              exit 1
            fi
            
      - name: Upload .env to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ELASTIC_IP }}
          username: ubuntu
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: ".env"
          target: "/home/ubuntu/app"
          
  # --------------------------------------------------------------------------
  # Job 3: Verify Deployment
  # --------------------------------------------------------------------------
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Wait for application startup
        run: sleep 30
        
      - name: Health Check
        run: |
          echo "ðŸ¥ Verifying production health..."
          if curl -f http://${{ secrets.ELASTIC_IP }}/health; then
            echo "âœ… Production is healthy!"
          else
            echo "âŒ Production health check failed!"
            exit 1
          fi
          
      - name: Smoke Test
        run: |
          echo "ðŸ§ª Running smoke tests..."
          # Add your smoke tests here
          # Example: curl -f http://${{ secrets.ELASTIC_IP }}/api/version
          echo "âœ… Smoke tests passed!"
          
  # --------------------------------------------------------------------------
  # Final Status Notification
  # --------------------------------------------------------------------------
  deployment-success:
    name: Deployment Success
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy, verify]
    if: success()
    
    steps:
      - name: Success Notification
        run: |
          echo "ðŸŽ‰ =================================="
          echo "   Deployment Successful!"
          echo "====================================ðŸŽ‰"
          echo ""
          echo "âœ… Images built and pushed to GHCR"
          echo "âœ… Deployed to production"
          echo "âœ… Health checks passed"
          echo "âœ… Smoke tests passed"
          echo ""
          echo "Production URL: http://${{ secrets.ELASTIC_IP }}"
